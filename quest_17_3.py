inp = """5646685564787778877467574787458687776856777878488573736645437374436755564774574374457766645345443536758878647774548877586855788777685675646864476768684
7688744464758766758854786685678576558555876448676355374535765646577554636366733553456643773676535434355766558846588764554444666587864687457577584856568
6674885757846567744746585644764585776455558567453357634347545734567437573355655377675367767644763647634546555465878576666857845456446748777688457444685
4886885554857485876568648777585668644675857763336757357775356653376756363756457344573554344776345366546566767448454447748854868464487448578455655676576
8768544585544485566555447868668548847547454443345754354664567454675437574557575673743563477676756367435767347335746687656457448645684675447887854885455
6854445648456884554858457657878687646767667644354474573766775663564754643545635364736734755646557547577367637746767866448456455746584877574787788757578
4884676648465844567478746587748658476654546346544467377755553633456364473647365367673374766743653564767567774736463685477466586685677844646656567465766
5845856484576568854465475556756588656637737357557663656467545344575337333453333653477657543477334474657537435667534657466548478565746847747654655886655
6565657887776868574445846586674683333537735746373777637575454556777775356111111155556474644765347567566556467363544553545466874677887476658676488855656
7745577844846688464788867688845574633746757766365363334743337637564651111199999115334744653757465474344676757576463544738466656745556466476765757744774
878487675644458568546865888888675735636435735333537444347765466447563199911S999914576344354543334744455577447436377653464557586647588457766848646864556
5458874847854665748465784678566537664545334644663354554743367674353731999999999914435456364545563633565664533665634454475348488675577777685876765584785
8665468586787478565475654484663674633766446743436635574333453364453351999999999913534533556557535376763776554435753767535756446475484477546644687876475
8657656748884756478674666843757564435746635376454647776576374363336455336999999317766436443435374464453546373743365563563657647577566685745468784856846
7556664877654584776658745564637355466537647556734677747737456555353566346799997315634635757444643577567454743773357574765655656557586556788675884668786
6656644577868654658786766664473346734344563636646473574435743535657476736434635765777766566457644365534533447533576375545445657764556564664847844674465
4564847766548864885445646567644676456576545646335364543334447744665333746764744464735455443457453577763537655745357655474744776566675557675765474547788
4865855555757667484665567336343347467343353767534776637436374657376563656445544766674536563656756674363643537347673435477665355437577574468888475784566
6888464655886755584673356556563575755356535554347754546733753476737444343435543537465534474747773734576635644543357447453767763366777774647584855855854
4666765585856564645775763665454637655373445765665555537776335477364756445577764547576345733353363365767533357333456353335464357353576586887864585547478
5775565646557457547674755355647357765356436666354745576465563574453344546744346773474747545573745557764676544637653336334435537737753666886588777545757
7746667544465645836545643366776355635734446466376557473576377454343337746775754457576777336644756353545535737347367536577454644555765547767455647488548
4454557478464747564773343756463537534753476454476734647554554664365673667424546655353675346675736734746374445334353466765575645533746346887856647664865
7864568876748566355565346577374533576535545377466447573544666753735455654225463224656233343755773656735577633454767567673664543454547645687585486546744
4576854645486855653666436356775454743445536637743334764445335545434224224533665325644422343435677576664535455445655673353573574733753335377584647645856
4564484645468757555773377545434737344343663535573665667755435465446535353434363234443346632323733473464466557645663577657653733653376757386845856774586
6878847585475365577466367656653643546736365775553773543633226343354435634446544226444443445623555763564556654467367543757767544676663777734588854787675
5576574446855565644653734743474454675766757444647574352235323222654432552253363223545465653466544353477375763545534547757355376636447574447654854545554
6757475556864747753654737474433436635365637766566742526653266555632442562432364663445236455453262623565473665367636677336634657646457445667787867545577
7844646784846346543574673475454347755376354436465256363443434332562335422546524334643544434663252443665345665346657645557467656636555575474756444668478
4784845854637445666346546333643673453363356656533246654443456623652552635253325626343433665535554324466544534473354333765375567464667667357374647768567
7657677766465746666466445774475564465363564555522366336365243434555665645544345326634445645222553536663324345436654334744744357475643377767737488785464
5684667746553667367336457456346737564746747363353426633665546254242666256652224523263434436354456365665524655475635645543537345464663667337373778555784
5665688533346553633546634746576767337775654263562234362243664624423244452646244364246453646523556553333524234735754633733575533467743446733433666477865
5578487745764776337543745365447375345764362535245635642625662233453223634522563463323636336226552343425423625356456746745554665673335775575545478485686
4677746473557374647757567377347447744554626245464532455632223524522253623453556445323446225566266546266223422666737773346664377366357566434443668647445
7564454446374455374447763356676654374774226462656422663355254263663546636232446446534555266523556443466262623336475445765447437676673374747353774748888
8655873775575476534376664357766473447652226555253642524446255654564354626566666364223323654433433245356264224546664573654573765675346665463757444874674
4468554573766635576543434776343755546663353463225536442336632253246443225564662232236345244352432264462562224256664337776447746746333746335635667676685
8667454775673355435536573355577673373554655556246554423423325356643552262665424645646662225324636565534656565436466675745434754776766453736467354776466
6857453477773646656775444437646556562334364242542625455625565663463522444656355526566344322236325243565244365356556565436435464754554453463736356366578
4644634435735373364656633733353554646225245423535546452235324222336633462554446663646366654625324255446646262423546273344674546573735765776357644375788
6874634365653463665667544335467345264454455243445536645225352244426243654563525333633365666244446445422256243256626335357534437334756337337534665667786
8846735343576447363573337643746636324352244254463236345225465525426655555326256652464423262462226233332366443466226343465333777436557744735573377574444
6774356443345366437336363537347733253656434523522543435432552362664544664644524242335226552322245252626625336266354235546337537454767476335744477734758
6667537373354537736374645374655765242333333466432426356323656226232262565464266635242442365566326355256255235643222645234646546464446754737644557763374
7575343665765676776643547367664366336225636245553544334624565453444562235644262634645345244254624365456555543222333343346335465576633377375664643665554
8754765574643753733663775445676566544222454446226245355553553342462255462623223524555563533253445355532263343222653456326547743455446743763464555435476
4344336735666375537466773434466554233233635243346634625334422254432434453535655545422626342433353642345235234452653262446637376355375454367537345576334
3345453756473743347745735734566652623524624342432523555246334542523653433525242233664226665664634233246626626322455234242676434466556477766465674655336
5435745346563534373735456555734224636545332653223634663644223433554352355234532235454226354632344523225256454432533266436654635753343534576754374775574
5647565675664546547347356666463453352362226446365665654642465253532534453323422442333546352632235443644635442223526665343655745437675464534634643354346
5343566675366575577737677557645622343632653662653346544446234532222353453222334445223535456223545543335665456436432653262335674736644434776354737634664
6765667535745334464334373454665546455622453225443643233522566552225423444435325334335554455242244244453325265543434363663336735573555444736577763537673
7674353755355776674656737543623356524534624455345564542556524523332533334522425554434535344524542644632444323466444355663642545345453676577453774764434
7534366447765634656467447456666522652634644365535233533423255444243224244543432424223543445233443322264255653652564523322656457545536536356634353464546
6577543745347345447554437543464543252523624663344454522565254434433435523524424555353445533232624456345352462244465556245345377657734356557773655333673
4456647533543434765547556346244226653436362444323545354335433335225252245535555544433232534234364454333326225235322652454662245553477447363634743763756
3443434354337347763754764246332245322342346254536635434453232524344343435324445224433525224524456566555662464565626623362464527553544463745434564536473
6547557646674745466766347545344432255226426564446235652444244345432243453324553533334543344543543666642426545545255622446355257655734447674765453656676
6345345433734675545546357256352646542444354463664446553254452442525533354523254343323343432343444265435443254322343463452554636477337473566553534467434
5347667454334546636363556624524656645335634425536262622523444254324344554322424452425525354554452453352423424242565656366255354466746774557534454744763
6556537437437435447434753624225624234254335562246546234553334454255545542255355455434322324254344453322332546443662552355534444654334745364464463665765
3343656773646773355347733244435346643652553524266226453245355444325432254253345243455454434233533533535525562256335352333343343765437546464733333674543
4335754743545553754766355252322434455623553225226324453345545522424225434524435535332232324354423245666465556534335226453435355643676737375775737636774
7734774766677566336443546265344654566424466553235324435344325234255555424324522333554225232234455255655265666342645546623625234674346747575744444354337
4535337355373534733777425545442322363345462645326243424224323223425542225544422224533435334552542223333266326366642342453223665645336365754646335346377
5443677774477573474755753462664446262465322632432244335322423354452433554553455245335253452545554435253263225623226544445442325373756673454477434777735
4645746463554337665335532525264234244536564422465652252535254222532324353232244532454425354255543524422236643225522433223235444454365564566533435735763
7474746673674754564665462522524364453564646333265235354542534545542352555425555432244222344553433523536664565544435565553325546666456545357363456433465
7746433433773436563445622366342532623226564323525443434345543525252444453525243554555533354235433234454546264546356556252565354373455735675547677444567
4553746773537346544465653366565244355355256336665232332243555432543543323232533325234534353523322235225635464455463652353425333336774354664675653457577
3346377666336545767447366232364523222465665545654244322553343244334444433423525234234525222344325435324264532644622433622646322544646676355536447775536
5563765735446345437655533545346343464355432364632232423232333545524222533555433433433543524344242343552424646345552554464666432653634665537535535477463
5347544363763773747333533364666566264253236526352335325453523454223255542234523425353234423435422353526242634632235456652464525556755643377476334746453
476637535363575733653624452544253632244666422346243235525333332255443452323@532534454234443233352323255554423444435455453432266363657675745365645475575
5655355777356676646675525322643323552622255664542433242345344235235243245599934235252345345342335252236324424254243543243442634557435434566343643356763
7663767676563466636675722236223534654366633456326322332524322333555553542299955255332332432525323334324653526265343365325662425244445746764633456773353
6376764557363473676745342556344645266235665265624445554355542342342233422499935353323233334425352343332466256363535626255534664675376743373476573774637
5653377433674577663334342322232363554333334452422224245232442334255542233399925343245334355353322442454436356425324264224362333347454354343443547533457
4446734656367477555745344642326534423525546433636544224555545545253342553399923244432342454342435252453642254434534252433464626245655556556355473454755
6536654753773535364647436264343653256522365232354655222355334243345533454499955233333542535334325534525666325653246633252252345634747434663776474437564
4367534364343774553657342645663554545534223363464323255342423532533454234299944552554422353443323444243246325265443334465266452647534377337766535353773
5536443345455333555547565542222524636562536322326624533343555542222522243299933233443333252444222235263556635326545243342626525533667345546733377753547
4453645653343373644576644524234545522552242346365253335323322452524225345299935445234424422552355534424256636354346364646422665454776467765766473553547
5677475454547775364534535544266342623252266556266364325332432434532425543299933443432425434525323532224455635435556434466552324345735475637455366676733
4577764355473343735334553335422222662632632464564364235242443443445454535599923344245432224524224345254653364435633253225666353776457533354665746334656
7647535763336736456673532433425534633334335552262426344354444354223332445299953223244322544243522243655252243444464264643454343454573547566463364653437
3533547337344646665664664426434534433346226555445423234234422454235244255399924242445433255433543446654425666633554354424664343334344367474673733374557
6744667377646545474674343655244355662346352354453635555224325544442543344599944235524432233445344424243454426444266555454666562734664643557634675555557
6643674753665764444377747224663334232634524533646636434423253534223255522499935333533543233434452656544653662623626546434555543744547454435567647335763
6644754576565663344734437633633545455336563442646656363442525454223522323299954435433232343445342336652652552355545346662263427634756336675776365667566
4777566537676564536654475552444463264234552322352233522252233323523444222399934232543345223333244363544343355426334233322626323734773744374665766763665
6364677644336547374674673622532335635523533653433666456453255422553222332499932242255455252353245225246433256465322654552323375756753433375363767447336
7363657656356343435467373732444453625524242564525362424522323324534523423399923245354433333344634652655642526222552336323535544743346356345366653735444
3557673735564675535546445562335226523255634355246643454543454322325552233299922545524242533253446525453542554244244262442226673346363634537555654473646
6757473433433744754663567466644434353645444242624633464235622254524553454399953242434554225264653556244245554534223455356335366755455374673334454743764
4747343747677476643755435732422256432235256636663643536655542223324354522299944543334453344245324436555232635534345622364262377647774354556376667447474
4377646577577646555644457743525256443232534542223436442233653324555352252299943354433435436262633564234255242346665325622455465447733477474446554656435
4455575767547674466344734446525544644222624624356244446366363432554222535399932455552536452526225324565362454552654452224546646364674357566576567347673
7347747776553633455733466343433466522356632342344644335332456632653432525599942332534636423526454534443662456353243324455447544376343637346576474565456
6345437665373636647657554653534463466562522442426566646264522234646552433299952346645436262266552566532542366536334632232334776753734434563377447376556
8534536556634347476637457337453656462622253626546523555663335653534426423399924455346244343566442355235532333443424626343364646734755743566673374743676
6664735746357375535774375653356266355355322334523566323623653466625565453699943525365334444653432643536342632644523644533644637436663745676554474644745
4535774575564333344477566764444225563444324454254252462654463526545533456699965333645224645645223642626533266225536624344433633657675633363477665656438
5554336474545473366365557756464724532245425362364423652263552524236225225299935555623545564624365553332266433533452325657767444776556346775475464464384
4533647354645535475765433334635752635623344324654546264446324526534255346299935634563552465322423455222553552464464553534457547736637543753546333467745
7473454636773475476337776353764535422544665423335544465636433656323632346299963344423366666542266423632365533546543265347564474436533743737577733435466
4457343767335564654673346334756434553454236336465644556623662353223253664499926244625562553524545446445624442226335456643575757577636735563664555475888
6464765473363333335755464557336757454362453454464356645346534252325526623599935634245544422534223233366625266256366267777346436733675734746453367767765
6574434534767334657433455434545437762352263344446445442643336356333354326499936524345225466622655625466523344253345334447463537757754753633435466534587
8578746456437553665573733544567637545325264442655466625352265445626456333599943462643664542666443222235424433623654736566645465536335765745374443788645
7586866573674334576375635565743343454652632456335322325455362436652234346599926655454336453444345453453325436636236473656354365635346654745374453355478
8574486334767357744373657765476347374733236642262654452353625464245225462299966456566435523223452463543636666255435336636765356445567665677734746467867
8447486637545445533553473373633547645477446463246664466633564365662466663399932344455565653623354322363554536243656447764555334753753757737556546486686
6765475476554547576464445766544443337363733433434663635456646545244536636299952633224253653252654356535543563236666777356537677455633643676556556674665
6747484576377445533756534345446756554457345453445433243562463255233243323699932536332622544446336642552543653467776335547674575464747763733434776476475
7877657553443357333753337567477774437454657546456225654233356533364566433299943653533662565523632366465654643676653753776734674634445347443365474755546
4646786466334436343535434776447763556656634353232254452643335224555443522699934454666342626546563422435645473655466676564667467753677374544476564456575
6657684564546374356566536736577436366567446546334423254355332653463422523399945633634445342422523642534663376776735673455555774564455674337655454456465
5445488455437375734567357466763773763637635435455225435634325556353645425599943452325656354326643635544255544554763643736344746655363475534436566578555
6784787884456666574476377345746733553737545745677243325334663432323232554599943543234526435343653254255735737555655734353755634336363647773646554545758
6546867478766763457333345335554476767464355653666455234542443434644535325599924253232253633535666366766366657335337635353567435667657643556556755447566
6775878766556756343734437456365767444376453366345535634446622454442256536299935544635354333566646573573537445747577357446476557554645363733754676745658
5757754557576534434546746546633747653676634674466567337336533224266265336399965566343433422436264767743454346456443445673776545665373767555547546686585
4658566488454546756334344753735736464673434666665763636454646356344664552599923254564222523665755354743743344644754334657775655766757765366865687676548
6876687865876677344677763653454444543756543636754756663736447623664353532499933432436254663535663743764546575344655766633376433556354736667874474654575
5557885685858487443374674745366775735465735363463556636755364444434253355699963524623674556435774374344757655653457365734775556657466766684464874688788
5446658746746566376543446453354776477436734354366464646643647746656364636399964677477547343663533636646655756577357667535566665746333657875567587645646
8485645857865856534755577345744575643544566544745545466373444466347367674399966547454567676753377435757443734753343647547533543674736667886667686645665
6887785775568744546635456373434375353476746634573534344476464655475777645699966374456757563475464643677676466654737737455337355557337748468764477464655
8768876858878558675774666645435437536356733463647457336377576646376667454799944467346353435636534677754333665446473744535764775677676656877766756544755
5874584554644585784545774443645654365366675375567674675365657374476663656499937737355646455333543346544635374667457666677775554574747488687768768667858
4775444556687487555563774775334774544566554566353475543344333646767677767499953673647756434773376534556345563634654365555774556665688576765565748588856
8457488776745467658585575636765336463734733654647575755446664776545436455399975363473467435755475334755733356643633645335636665657686448557466464744665
8745658766556667655767757364644766557456576554744664565753666674537333575399977764477756747473443643334736367755477435477677353488778554886886445674776
6554686756777476446845775635477654643534545453737445673676433647674774754499934557565337437335457756636574553456635745374333335676756746567747647774487
4587874686877857578768455443644457555563363674453364747635647545755335556699933737774577446544464445435737736335546554547356557488475786574447476786457
4455585566878557587558465756653537564763746576575437545633657763666335475799936355445756766674633775354665345346375774347534486576646445574775648777487
4885685648545646866556586846374353465346747666744636666346537356457555666799955466577774543555376456577556737356735655554767876587486564847855874546778
6865787684668647656868567665487636435336545667444565753454356747456355575799935763536565735733743674337473344374576363744668876648868765664586476747658
4865447747654866564458588745485457535475346343364355646664744476444334534499967775454645674575753446376376567554477666666676787564555458785454867767468
4666746755764546654777845455868645737656437356655763636665566767553377635599933545733366565375555363474637363447656745774767444667667878568564758876688
4757744584588748768587668886664765544644577376473353777733547655467477457799967667444376656653675757677473555444733645484565454487468887885668865447474
7667846684487686448656755486474645685474737357563676635375576755446563755499964463374447376774533574637667364744437456668586577486677774888488456468846
8778788555678748688886786584665678868635333466446344565764464363555364334599953743755634447656754675463445743737367564777754757647558646467845746544445
4866457777578777686857775785756766887855544455364475676737374566754365655699976564656374555664666773664536546567477654767658777476658575768776887854666
5486667678645475575864855744647684486647444374657366365665456733473775474399944565477433475543435344635747534767587648786744544484788684585677455748875
5764857568775766687447678587755667467476854856536766635656675754766555434699975535353756773455777473346455776588665588475674744888664444468878647747776
6865765746745576887578656764655776878757476456775775767475764677676465734699946446553546453577434373776765865747658558647575655845765686864884788474464
4645885754564765577777648854688465677676564758445334735565574564467474746599943646566756743477574633758854454856668664656484475486576686877648676865446"""
test_inp_1 = """2645233S5466644
634566343252465
353336645243246
233343552544555
225243326235365
536334634462246
666344656233244
6426432@2366453
364346442652235
253652463426433
426666225623563
555462553462364
346225464436334
643362324542432
463332353552464"""
test_inp_2 = """545233443422255434324
5222533434S2322342222
523444354223232542432
553522225435232255242
232343243532432452524
245245322252324442542
252533232225244224355
523533554454232553332
522332223232242523223
524523432425432244432
3532242243@4323422334
542524223994422443222
252343244322522222332
253355425454255523242
344324325233443552555
423523225325255345522
244333345244325322335
242244352245522323422
443332352222535334325
323532222353523253542
553545434425235223552"""
test_inp_3 = """5441525241225111112253553251553
133522122534119S911411222155114
3445445533355599933443455544333
3345333555434334535435433335533
5353333345335554434535533555354
3533533435355443543433453355553
3553353435335554334453355435433
5435355533533355533535335345335
4353545353545354555534334453353
4454543553533544443353355553453
5334554534533355333355543533454
4433333345445354553533554555533
5554454343455334355445533453453
4435554534445553335434455334353
3533435453433535345355533545555
534433533533535@353533355553345
4453545555435334544453344455554
4353333535535354535353353535355
4345444453554554535355345343354
3534544535533355333333445433555
3535333335335334333534553543535
5433355333553344355555344553435
5355535355535334555435534555344
3355433335553553535334544544333
3554333535553335343555345553535
3554433545353554334554345343343
5533353435533535333355343333555
5355555353355553535354333535355
4344534353535455333455353335333
5444333535533453535335454535553
3534343355355355553543545553345"""


def map_volcato(inp):
    volcano = None
    start = None
    grid = dict()
    for yidx, line in enumerate(inp.splitlines()):
        for xidx, ch in enumerate(line):
            if ch == '@':
                volcano = (xidx, yidx)
            elif ch == 'S':
                start = (xidx, yidx)
                grid[(xidx, yidx)] = 0
            elif ch.isdigit():
                grid[(xidx, yidx)] = int(ch)
    return volcano, start, grid
    
    
from collections import deque
def find_best_path(volcano, grid, start, goal, max_time): 
    if start[1] > goal[1]:
        print(f"Backwards")
        print(start, goal)
        print(start in grid, goal in grid)
    print(f"Finding best path from {start} to {goal}")   
    queue = deque()
    queue.append((start, 0))
    visited = {start: 0}
    best_time = None
    while queue:
        pos, time = queue.popleft()
        for dx, dy in [(-1,0),(1,0),(0,-1),(0,1)]:
            new_pos = (pos[0] + dx, pos[1] + dy)
            if new_pos not in grid:
                continue
            new_time = time + grid[new_pos]
            if new_time > max_time:
                continue
            if new_pos == goal:
                if best_time is None or new_time < best_time:
                    input(f"  Reached goal at time {new_time}")
                    best_time = new_time
                    bt_pos = new_pos
                    while bt_pos != start:
                        print(f"    Backtrack: {bt_pos} at time {new_time}")
                        for pdx, pdy in [(-1,0),(1,0),(0,-1),(0,1)]:
                            prev_pos = (bt_pos[0] + pdx, bt_pos[1] + pdy)
                            if prev_pos in visited and visited[prev_pos] + grid[bt_pos] == new_time:
                                bt_pos = prev_pos
                                break
                continue
            dist_to_volcano = abs(new_pos[0] - volcano[0])**2 + abs(new_pos[1] - volcano[1])**2
            if dist_to_volcano <= (max_time // 30)**2 + 1:
                continue
            state = (new_pos, new_time)
            if state not in visited or visited[state] > new_time:
                visited[state] = new_time
                queue.append((new_pos, new_time))
    return best_time
    

def best_path(inp):
    volcano, start, grid = map_volcato(inp)
    max_radius = max(abs(x - volcano[0]) + abs(y - volcano[1]) for (x, y) in grid.keys())
    left_grid = {k: v for k, v in grid.items() if k[0] <= volcano[0]}
    right_grid = {k: v for k, v in grid.items() if k[0] >= volcano[0]}
    time = 29
    while True:
        print(f"Trying time limit: {time}")
        best_time = time + 1
        for y in range(volcano[1], volcano[1] + max_radius):
            ltime = find_best_path(volcano, left_grid, start, (volcano[0], y), time)
            if ltime is None:
                continue
            rtime = find_best_path(volcano, right_grid, (volcano[0], y), start, time - ltime)
            if rtime is None:
                continue
            print(f"  Found path via ({volcano[0]}, {y}): L:{ltime} + R:{rtime} = {ltime + rtime}")
            if ltime + rtime <= best_time:
                best_time = ltime + rtime
                print(f"  New best time via ({volcano[0]}, {y}): {best_time} (L:{ltime} + R:{rtime})")
        if best_time <= time:
            print(f"Best time found: {best_time}")
            return best_time
        time += 30
    return 0
    
    
def main():
    print(f"Volcano danger zone (examples): {best_path(test_inp_1)}")
    print(f"Volcano danger zone (examples): {best_path(test_inp_2)}")
    print(f"Volcano danger zone (examples): {best_path(test_inp_3)}")
    print(f"Volcano danger zone (actual): {best_path(inp)}")
    
if __name__ == "__main__":
    main()